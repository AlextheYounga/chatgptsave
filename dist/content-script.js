var $=Object.defineProperty;var F=(t,e,n)=>e in t?$(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n;var f=(t,e,n)=>F(t,typeof e!="symbol"?e+"":e,n);const g=class g{constructor(){this.accessToken=null,this.pendingAccessToken=null}async getAccessToken(){return this.accessToken?this.accessToken:(this.pendingAccessToken||(this.pendingAccessToken=this.requestAccessToken().then(e=>(this.accessToken=e,e)).catch(e=>{throw this.pendingAccessToken=null,e})),this.pendingAccessToken)}async requestAccessToken(){const e=await fetch(g.SESSION_ENDPOINT,{method:"GET",credentials:"include",headers:{accept:"application/json"}});if(!e.ok)throw new Error(`Session request failed: ${e.status}`);const n=await e.json(),r=n==null?void 0:n.accessToken;if(!r)throw new Error("Session response missing access token.");return r}async getDeviceId(){const e=["oai_device_id","oai-device-id","oai_deviceId","oaiDeviceId"];for(const n of e){const r=window.localStorage.getItem(n);if(r)return r}return this.readCookie("oai_device_id")||this.readCookie("oai-device-id")}readCookie(e){const n=new RegExp(`(?:^|; )${e.replace(/([.$?*|{}()\[\]\\\/\+^])/g,"\\$1")}=([^;]*)`),r=document.cookie.match(n);return r?decodeURIComponent(r[1]):null}};f(g,"SESSION_ENDPOINT","https://chatgpt.com/api/auth/session");let y=g;class W{constructor(){f(this,"CONVERSATION_ENDPOINT",e=>`https://chatgpt.com/backend-api/conversation/${e}`);this.authManager=new y}async fetchConversation(){const e=this.currentConversationId();if(!e)throw new Error("Unable to determine conversation id from URL.");const[n,r]=await Promise.all([this.authManager.getAccessToken(),this.authManager.getDeviceId()]);if(!n)throw new Error("Missing access token. Please ensure you are logged in.");const i=new Headers({accept:"application/json",authorization:`Bearer ${n}`,"x-openai-assistant-app-id":"chat.openai.com"});r&&i.set("oai-device-id",r);const o=await fetch(this.CONVERSATION_ENDPOINT(e),{method:"GET",credentials:"include",headers:i});if(!o.ok)throw new Error(`Conversation request failed: ${o.status}`);return o.json()}currentConversationId(){const e=new URL(window.location.href),n=e.pathname.split("/").filter(Boolean),r=n.indexOf("c");if(r!==-1&&n.length>r+1)return n[r+1];if(n.length){const i=n[n.length-1];if(this.isUuid(i))return i}return e.searchParams.get("conversationId")||e.searchParams.get("conversation_id")}isUuid(e){return typeof e=="string"&&/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(e)}}function U(t){for(var e=1;e<arguments.length;e++){var n=arguments[e];for(var r in n)n.hasOwnProperty(r)&&(t[r]=n[r])}return t}function k(t,e){return Array(e+1).join(t)}function q(t){return t.replace(/^\n*/,"")}function V(t){for(var e=t.length;e>0&&t[e-1]===`
`;)e--;return t.substring(0,e)}var j=["ADDRESS","ARTICLE","ASIDE","AUDIO","BLOCKQUOTE","BODY","CANVAS","CENTER","DD","DIR","DIV","DL","DT","FIELDSET","FIGCAPTION","FIGURE","FOOTER","FORM","FRAMESET","H1","H2","H3","H4","H5","H6","HEADER","HGROUP","HR","HTML","ISINDEX","LI","MAIN","MENU","NAV","NOFRAMES","NOSCRIPT","OL","OUTPUT","P","PRE","SECTION","TABLE","TBODY","TD","TFOOT","TH","THEAD","TR","UL"];function N(t){return b(t,j)}var L=["AREA","BASE","BR","COL","COMMAND","EMBED","HR","IMG","INPUT","KEYGEN","LINK","META","PARAM","SOURCE","TRACK","WBR"];function I(t){return b(t,L)}function G(t){return P(t,L)}var B=["A","TABLE","THEAD","TBODY","TFOOT","TH","TD","IFRAME","SCRIPT","AUDIO","VIDEO"];function Y(t){return b(t,B)}function z(t){return P(t,B)}function b(t,e){return e.indexOf(t.nodeName)>=0}function P(t,e){return t.getElementsByTagName&&e.some(function(n){return t.getElementsByTagName(n).length})}var c={};c.paragraph={filter:"p",replacement:function(t){return`

`+t+`

`}};c.lineBreak={filter:"br",replacement:function(t,e,n){return n.br+`
`}};c.heading={filter:["h1","h2","h3","h4","h5","h6"],replacement:function(t,e,n){var r=Number(e.nodeName.charAt(1));if(n.headingStyle==="setext"&&r<3){var i=k(r===1?"=":"-",t.length);return`

`+t+`
`+i+`

`}else return`

`+k("#",r)+" "+t+`

`}};c.blockquote={filter:"blockquote",replacement:function(t){return t=t.replace(/^\n+|\n+$/g,""),t=t.replace(/^/gm,"> "),`

`+t+`

`}};c.list={filter:["ul","ol"],replacement:function(t,e){var n=e.parentNode;return n.nodeName==="LI"&&n.lastElementChild===e?`
`+t:`

`+t+`

`}};c.listItem={filter:"li",replacement:function(t,e,n){var r=n.bulletListMarker+"   ",i=e.parentNode;if(i.nodeName==="OL"){var o=i.getAttribute("start"),a=Array.prototype.indexOf.call(i.children,e);r=(o?Number(o)+a:a+1)+".  "}return t=t.replace(/^\n+/,"").replace(/\n+$/,`
`).replace(/\n/gm,`
`+" ".repeat(r.length)),r+t+(e.nextSibling&&!/\n$/.test(t)?`
`:"")}};c.indentedCodeBlock={filter:function(t,e){return e.codeBlockStyle==="indented"&&t.nodeName==="PRE"&&t.firstChild&&t.firstChild.nodeName==="CODE"},replacement:function(t,e,n){return`

    `+e.firstChild.textContent.replace(/\n/g,`
    `)+`

`}};c.fencedCodeBlock={filter:function(t,e){return e.codeBlockStyle==="fenced"&&t.nodeName==="PRE"&&t.firstChild&&t.firstChild.nodeName==="CODE"},replacement:function(t,e,n){for(var r=e.firstChild.getAttribute("class")||"",i=(r.match(/language-(\S+)/)||[null,""])[1],o=e.firstChild.textContent,a=n.fence.charAt(0),l=3,s=new RegExp("^"+a+"{3,}","gm"),d;d=s.exec(o);)d[0].length>=l&&(l=d[0].length+1);var h=k(a,l);return`

`+h+i+`
`+o.replace(/\n$/,"")+`
`+h+`

`}};c.horizontalRule={filter:"hr",replacement:function(t,e,n){return`

`+n.hr+`

`}};c.inlineLink={filter:function(t,e){return e.linkStyle==="inlined"&&t.nodeName==="A"&&t.getAttribute("href")},replacement:function(t,e){var n=e.getAttribute("href");n&&(n=n.replace(/([()])/g,"\\$1"));var r=p(e.getAttribute("title"));return r&&(r=' "'+r.replace(/"/g,'\\"')+'"'),"["+t+"]("+n+r+")"}};c.referenceLink={filter:function(t,e){return e.linkStyle==="referenced"&&t.nodeName==="A"&&t.getAttribute("href")},replacement:function(t,e,n){var r=e.getAttribute("href"),i=p(e.getAttribute("title"));i&&(i=' "'+i+'"');var o,a;switch(n.linkReferenceStyle){case"collapsed":o="["+t+"][]",a="["+t+"]: "+r+i;break;case"shortcut":o="["+t+"]",a="["+t+"]: "+r+i;break;default:var l=this.references.length+1;o="["+t+"]["+l+"]",a="["+l+"]: "+r+i}return this.references.push(a),o},references:[],append:function(t){var e="";return this.references.length&&(e=`

`+this.references.join(`
`)+`

`,this.references=[]),e}};c.emphasis={filter:["em","i"],replacement:function(t,e,n){return t.trim()?n.emDelimiter+t+n.emDelimiter:""}};c.strong={filter:["strong","b"],replacement:function(t,e,n){return t.trim()?n.strongDelimiter+t+n.strongDelimiter:""}};c.code={filter:function(t){var e=t.previousSibling||t.nextSibling,n=t.parentNode.nodeName==="PRE"&&!e;return t.nodeName==="CODE"&&!n},replacement:function(t){if(!t)return"";t=t.replace(/\r?\n|\r/g," ");for(var e=/^`|^ .*?[^ ].* $|`$/.test(t)?" ":"",n="`",r=t.match(/`+/gm)||[];r.indexOf(n)!==-1;)n=n+"`";return n+e+t+e+n}};c.image={filter:"img",replacement:function(t,e){var n=p(e.getAttribute("alt")),r=e.getAttribute("src")||"",i=p(e.getAttribute("title")),o=i?' "'+i+'"':"";return r?"!["+n+"]("+r+o+")":""}};function p(t){return t?t.replace(/(\n+\s*)+/g,`
`):""}function x(t){this.options=t,this._keep=[],this._remove=[],this.blankRule={replacement:t.blankReplacement},this.keepReplacement=t.keepReplacement,this.defaultRule={replacement:t.defaultReplacement},this.array=[];for(var e in t.rules)this.array.push(t.rules[e])}x.prototype={add:function(t,e){this.array.unshift(e)},keep:function(t){this._keep.unshift({filter:t,replacement:this.keepReplacement})},remove:function(t){this._remove.unshift({filter:t,replacement:function(){return""}})},forNode:function(t){if(t.isBlank)return this.blankRule;var e;return(e=w(this.array,t,this.options))||(e=w(this._keep,t,this.options))||(e=w(this._remove,t,this.options))?e:this.defaultRule},forEach:function(t){for(var e=0;e<this.array.length;e++)t(this.array[e],e)}};function w(t,e,n){for(var r=0;r<t.length;r++){var i=t[r];if(X(i,e,n))return i}}function X(t,e,n){var r=t.filter;if(typeof r=="string"){if(r===e.nodeName.toLowerCase())return!0}else if(Array.isArray(r)){if(r.indexOf(e.nodeName.toLowerCase())>-1)return!0}else if(typeof r=="function"){if(r.call(t,e,n))return!0}else throw new TypeError("`filter` needs to be a string, array, or function")}function K(t){var e=t.element,n=t.isBlock,r=t.isVoid,i=t.isPre||function(_){return _.nodeName==="PRE"};if(!(!e.firstChild||i(e))){for(var o=null,a=!1,l=null,s=C(l,e,i);s!==e;){if(s.nodeType===3||s.nodeType===4){var d=s.data.replace(/[ \r\n\t]+/g," ");if((!o||/ $/.test(o.data))&&!a&&d[0]===" "&&(d=d.substr(1)),!d){s=E(s);continue}s.data=d,o=s}else if(s.nodeType===1)n(s)||s.nodeName==="BR"?(o&&(o.data=o.data.replace(/ $/,"")),o=null,a=!1):r(s)||i(s)?(o=null,a=!0):o&&(a=!1);else{s=E(s);continue}var h=C(l,s,i);l=s,s=h}o&&(o.data=o.data.replace(/ $/,""),o.data||E(o))}}function E(t){var e=t.nextSibling||t.parentNode;return t.parentNode.removeChild(t),e}function C(t,e,n){return t&&t.parentNode===e||n(e)?e.nextSibling||e.parentNode:e.firstChild||e.nextSibling||e.parentNode}var S=typeof window<"u"?window:{};function Q(){var t=S.DOMParser,e=!1;try{new t().parseFromString("","text/html")&&(e=!0)}catch{}return e}function J(){var t=function(){};return Z()?t.prototype.parseFromString=function(e){var n=new window.ActiveXObject("htmlfile");return n.designMode="on",n.open(),n.write(e),n.close(),n}:t.prototype.parseFromString=function(e){var n=document.implementation.createHTMLDocument("");return n.open(),n.write(e),n.close(),n},t}function Z(){var t=!1;try{document.implementation.createHTMLDocument("").open()}catch{S.ActiveXObject&&(t=!0)}return t}var ee=Q()?S.DOMParser:J();function te(t,e){var n;if(typeof t=="string"){var r=ne().parseFromString('<x-turndown id="turndown-root">'+t+"</x-turndown>","text/html");n=r.getElementById("turndown-root")}else n=t.cloneNode(!0);return K({element:n,isBlock:N,isVoid:I,isPre:e.preformattedCode?re:null}),n}var T;function ne(){return T=T||new ee,T}function re(t){return t.nodeName==="PRE"||t.nodeName==="CODE"}function ie(t,e){return t.isBlock=N(t),t.isCode=t.nodeName==="CODE"||t.parentNode.isCode,t.isBlank=oe(t),t.flankingWhitespace=ae(t,e),t}function oe(t){return!I(t)&&!Y(t)&&/^\s*$/i.test(t.textContent)&&!G(t)&&!z(t)}function ae(t,e){if(t.isBlock||e.preformattedCode&&t.isCode)return{leading:"",trailing:""};var n=se(t.textContent);return n.leadingAscii&&O("left",t,e)&&(n.leading=n.leadingNonAscii),n.trailingAscii&&O("right",t,e)&&(n.trailing=n.trailingNonAscii),{leading:n.leading,trailing:n.trailing}}function se(t){var e=t.match(/^(([ \t\r\n]*)(\s*))(?:(?=\S)[\s\S]*\S)?((\s*?)([ \t\r\n]*))$/);return{leading:e[1],leadingAscii:e[2],leadingNonAscii:e[3],trailing:e[4],trailingNonAscii:e[5],trailingAscii:e[6]}}function O(t,e,n){var r,i,o;return t==="left"?(r=e.previousSibling,i=/ $/):(r=e.nextSibling,i=/^ /),r&&(r.nodeType===3?o=i.test(r.nodeValue):n.preformattedCode&&r.nodeName==="CODE"?o=!1:r.nodeType===1&&!N(r)&&(o=i.test(r.textContent))),o}var le=Array.prototype.reduce,ce=[[/\\/g,"\\\\"],[/\*/g,"\\*"],[/^-/g,"\\-"],[/^\+ /g,"\\+ "],[/^(=+)/g,"\\$1"],[/^(#{1,6}) /g,"\\$1 "],[/`/g,"\\`"],[/^~~~/g,"\\~~~"],[/\[/g,"\\["],[/\]/g,"\\]"],[/^>/g,"\\>"],[/_/g,"\\_"],[/^(\d+)\. /g,"$1\\. "]];function m(t){if(!(this instanceof m))return new m(t);var e={rules:c,headingStyle:"setext",hr:"* * *",bulletListMarker:"*",codeBlockStyle:"indented",fence:"```",emDelimiter:"_",strongDelimiter:"**",linkStyle:"inlined",linkReferenceStyle:"full",br:"  ",preformattedCode:!1,blankReplacement:function(n,r){return r.isBlock?`

`:""},keepReplacement:function(n,r){return r.isBlock?`

`+r.outerHTML+`

`:r.outerHTML},defaultReplacement:function(n,r){return r.isBlock?`

`+n+`

`:n}};this.options=U({},e,t),this.rules=new x(this.options)}m.prototype={turndown:function(t){if(!fe(t))throw new TypeError(t+" is not a string, or an element/document/fragment node.");if(t==="")return"";var e=M.call(this,new te(t,this.options));return ue.call(this,e)},use:function(t){if(Array.isArray(t))for(var e=0;e<t.length;e++)this.use(t[e]);else if(typeof t=="function")t(this);else throw new TypeError("plugin must be a Function or an Array of Functions");return this},addRule:function(t,e){return this.rules.add(t,e),this},keep:function(t){return this.rules.keep(t),this},remove:function(t){return this.rules.remove(t),this},escape:function(t){return ce.reduce(function(e,n){return e.replace(n[0],n[1])},t)}};function M(t){var e=this;return le.call(t.childNodes,function(n,r){r=new ie(r,e.options);var i="";return r.nodeType===3?i=r.isCode?r.nodeValue:e.escape(r.nodeValue):r.nodeType===1&&(i=de.call(e,r)),H(n,i)},"")}function ue(t){var e=this;return this.rules.forEach(function(n){typeof n.append=="function"&&(t=H(t,n.append(e.options)))}),t.replace(/^[\t\r\n]+/,"").replace(/[\t\r\n\s]+$/,"")}function de(t){var e=this.rules.forNode(t),n=M.call(this,t),r=t.flankingWhitespace;return(r.leading||r.trailing)&&(n=n.trim()),r.leading+e.replacement(n,t,this.options)+r.trailing}function H(t,e){var n=V(t),r=q(e),i=Math.max(t.length-n.length,e.length-r.length),o=`

`.substring(0,i);return n+o+r}function fe(t){return t!=null&&(typeof t=="string"||t.nodeType&&(t.nodeType===1||t.nodeType===9||t.nodeType===11))}const he="#thread article";class pe{constructor(){this.turndown=new m({bulletListMarker:"-",codeBlockStyle:"fenced"})}parse(){const e={},n=document.querySelectorAll(he);if(!n||n.length===0)return"";for(const r of n){const i=r.getAttribute("data-turn-id");if(!i)continue;const o=r.innerHTML,a=this.normalizePreCode(o),l=this.turndown.turndown(a);l&&(e[i]=l)}return e}normalizePreCode(e){const n=document.createElement("div");return n.innerHTML=e,n.querySelectorAll("pre").forEach(r=>{var l,s,d;const i=r.querySelectorAll("code");if(!i.length)return;const o=i[0];o.parentElement!==r&&r.insertBefore(o,r.firstChild),Array.from(r.childNodes).forEach(h=>{h!==o&&h.remove()});const a=((l=o.className.match(/(^|\s)(language-[^\s]+)/))==null?void 0:l[2])||((d=(s=r.className)==null?void 0:s.match(/(^|\s)(language-[^\s]+)/))==null?void 0:d[2]);a&&!o.className.includes(a)&&o.classList.add(a)}),n.innerHTML}}const u=class u{constructor(e,n){this.downloadFormats=e,this.onFormatSelectedCallback=n,this.dropdown=null,this.dropdownAnchor=null,this.detachDropdownListeners=null}init(){this.injectStyles(),this.attachDownloadButton(),this.observeShareButton()}injectStyles(){if(document.getElementById(u.STYLE_ID))return;const e=document.createElement("style");e.id=u.STYLE_ID,e.textContent=`
      #${u.DOWNLOAD_BUTTON_ID} svg {
        transform: rotate(180deg);
      }
    `,document.head.appendChild(e)}observeShareButton(){new MutationObserver(()=>this.attachDownloadButton()).observe(document.body,{childList:!0,subtree:!0})}attachDownloadButton(){const e=document.querySelector(u.SHARE_BUTTON_SELECTOR);if(!e)return;const n=e.parentElement;if(!n||n.querySelector(`#${u.DOWNLOAD_BUTTON_ID}`))return;const r=this.cloneShareButton(e);n.insertBefore(r,e.nextSibling)}cloneShareButton(e){const n=e.cloneNode(!0);n.id=u.DOWNLOAD_BUTTON_ID,n.setAttribute("aria-label","Download conversation"),n.dataset.testid="download-chat-button";const r=n.querySelector(".flex");r&&this.replaceLabel(r,"Download");const i=n.querySelector("svg");return i&&i.setAttribute("aria-label","Download icon"),n.addEventListener("click",o=>{o.preventDefault(),o.stopPropagation(),this.toggleDropdown(n)}),n}replaceLabel(e,n){let r=!1;for(const i of Array.from(e.childNodes))i.nodeType===Node.TEXT_NODE&&(i.textContent=n,r=!0);r||e.appendChild(document.createTextNode(n))}toggleDropdown(e){if(this.dropdown&&this.dropdownAnchor===e){this.closeDropdown();return}this.openDropdown(e)}openDropdown(e){const n=this.ensureDropdown();if(n.hidden=!1,n.style.visibility="hidden",this.positionDropdown(e,n),n.style.visibility="",n.setAttribute("data-state","open"),this.dropdown=n,this.dropdownAnchor=e,!this.detachDropdownListeners){const r=o=>{var a;this.dropdown&&((a=this.dropdownAnchor)!=null&&a.contains(o.target)||this.dropdown.contains(o.target)||this.closeDropdown())},i=o=>{o.key==="Escape"&&this.closeDropdown()};document.addEventListener("click",r,!0),document.addEventListener("keydown",i),this.detachDropdownListeners=()=>{document.removeEventListener("click",r,!0),document.removeEventListener("keydown",i),this.detachDropdownListeners=null}}}closeDropdown(){this.dropdown&&(this.dropdown.hidden=!0,this.dropdown.setAttribute("data-state","closed"),this.dropdown=null,this.dropdownAnchor=null,this.detachDropdownListeners&&this.detachDropdownListeners())}ensureDropdown(){let e=document.getElementById(u.DROPDOWN_ID);if(e)return e;e=document.createElement("div"),e.id=u.DROPDOWN_ID,e.setAttribute("role","menu"),e.setAttribute("data-state","closed"),e.className="z-50 absolute rounded-2xl bg-token-main-surface-primary dark:bg-[#353535] shadow-long py-1.5 border border-token-border-light min-w-[180px] text-token-text-primary",e.hidden=!0;const n=document.createElement("div");return n.setAttribute("role","group"),n.className="flex flex-col gap-1",n.appendChild(this.createDropdownItem("JSON",this.downloadFormats.json)),n.appendChild(this.createDropdownItem("Markdown",this.downloadFormats.markdown)),e.appendChild(n),document.body.appendChild(e),e}createDropdownItem(e,n){const r=document.createElement("button");return r.type="button",r.setAttribute("role","menuitem"),r.dataset.option=n,r.className="__menu-item flex w-full items-center gap-1.5 px-4 py-2 text-sm text-left hover:bg-token-main-surface-secondary rounded-xl focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-token-border-light",r.textContent=e,r.addEventListener("click",i=>{i.preventDefault(),i.stopPropagation(),this.closeDropdown(),this.onFormatSelectedCallback(n)}),r}positionDropdown(e,n){const r=e.getBoundingClientRect(),i=window.scrollY||document.documentElement.scrollTop||0,o=window.scrollX||document.documentElement.scrollLeft||0;n.style.top=`${r.bottom+i+8}px`,n.style.left=`${r.right+o-n.offsetWidth}px`}};f(u,"SHARE_BUTTON_SELECTOR",'button[data-testid="share-chat-button"]'),f(u,"DOWNLOAD_BUTTON_ID","chatgpt-save-download-button"),f(u,"STYLE_ID","chatgpt-save-style"),f(u,"DROPDOWN_ID","chatgpt-save-download-dropdown");let A=u;const R=Object.freeze({json:"json",markdown:"markdown"}),v=class v{requestDownload(e){return new Promise((n,r)=>{chrome.runtime.sendMessage({type:v.MESSAGE_TYPE,payload:e},i=>{const o=chrome.runtime.lastError;if(o){r(new Error(o.message));return}if(!(i!=null&&i.ok)){r(new Error((i==null?void 0:i.error)||"Download failed."));return}n(i)})})}};f(v,"MESSAGE_TYPE","CHATGPT_SAVE_DOWNLOAD_REQUEST");let D=v;class me{constructor(){this.apiHandler=new W,this.bridge=new D,this.parser=new pe,this.ui=new A(R,(function(e){return this.handleDownload(e)}).bind(this))}init(){this.ui.init()}async handleDownload(e){try{const n=await this.apiHandler.fetchConversation();if(!n)throw new Error("Conversation payload was empty.");const r={format:e,openAIResponse:n};if(e===R.markdown){const i=this.parser.parse();r.markdownMessages=i}await this.bridge.requestDownload(r)}catch(n){console.warn("ChatGPT Save: failed to prepare download.",n)}}}new me().init();
