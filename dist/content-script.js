var $=Object.defineProperty;var F=(e,t,n)=>t in e?$(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n;var f=(e,t,n)=>F(e,typeof t!="symbol"?t+"":t,n);const g=class g{constructor(){this.accessToken=null,this.pendingAccessToken=null}async getAccessToken(){return this.accessToken?this.accessToken:(this.pendingAccessToken||(this.pendingAccessToken=this.requestAccessToken().then(t=>(this.accessToken=t,t)).catch(t=>{throw this.pendingAccessToken=null,t})),this.pendingAccessToken)}async requestAccessToken(){const t=await fetch(g.SESSION_ENDPOINT,{method:"GET",credentials:"include",headers:{accept:"application/json"}});if(!t.ok)throw new Error(`Session request failed: ${t.status}`);const n=await t.json(),r=n==null?void 0:n.accessToken;if(!r)throw new Error("Session response missing access token.");return r}async getDeviceId(){const t=["oai_device_id","oai-device-id","oai_deviceId","oaiDeviceId"];for(const n of t){const r=window.localStorage.getItem(n);if(r)return r}return this.readCookie("oai_device_id")||this.readCookie("oai-device-id")}readCookie(t){const n=new RegExp(`(?:^|; )${t.replace(/([.$?*|{}()\[\]\\\/\+^])/g,"\\$1")}=([^;]*)`),r=document.cookie.match(n);return r?decodeURIComponent(r[1]):null}};f(g,"SESSION_ENDPOINT","https://chatgpt.com/api/auth/session");let D=g;class W{constructor(){f(this,"CONVERSATION_ENDPOINT",t=>`https://chatgpt.com/backend-api/conversation/${t}`);this.authManager=new D}async fetchConversation(){const t=this.currentConversationId();if(!t)throw new Error("Unable to determine conversation id from URL.");const[n,r]=await Promise.all([this.authManager.getAccessToken(),this.authManager.getDeviceId()]);if(!n)throw new Error("Missing access token. Please ensure you are logged in.");const i=new Headers({accept:"application/json",authorization:`Bearer ${n}`,"x-openai-assistant-app-id":"chat.openai.com"});r&&i.set("oai-device-id",r);const o=await fetch(this.CONVERSATION_ENDPOINT(t),{method:"GET",credentials:"include",headers:i});if(!o.ok)throw new Error(`Conversation request failed: ${o.status}`);return o.json()}currentConversationId(){const t=new URL(window.location.href),n=t.pathname.split("/").filter(Boolean),r=n.indexOf("c");if(r!==-1&&n.length>r+1)return n[r+1];if(n.length){const i=n[n.length-1];if(this.isUuid(i))return i}return t.searchParams.get("conversationId")||t.searchParams.get("conversation_id")}isUuid(t){return typeof t=="string"&&/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(t)}}function U(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)n.hasOwnProperty(r)&&(e[r]=n[r])}return e}function k(e,t){return Array(t+1).join(e)}function V(e){return e.replace(/^\n*/,"")}function j(e){for(var t=e.length;t>0&&e[t-1]===`
`;)t--;return e.substring(0,t)}var q=["ADDRESS","ARTICLE","ASIDE","AUDIO","BLOCKQUOTE","BODY","CANVAS","CENTER","DD","DIR","DIV","DL","DT","FIELDSET","FIGCAPTION","FIGURE","FOOTER","FORM","FRAMESET","H1","H2","H3","H4","H5","H6","HEADER","HGROUP","HR","HTML","ISINDEX","LI","MAIN","MENU","NAV","NOFRAMES","NOSCRIPT","OL","OUTPUT","P","PRE","SECTION","TABLE","TBODY","TD","TFOOT","TH","THEAD","TR","UL"];function N(e){return b(e,q)}var L=["AREA","BASE","BR","COL","COMMAND","EMBED","HR","IMG","INPUT","KEYGEN","LINK","META","PARAM","SOURCE","TRACK","WBR"];function I(e){return b(e,L)}function G(e){return P(e,L)}var B=["A","TABLE","THEAD","TBODY","TFOOT","TH","TD","IFRAME","SCRIPT","AUDIO","VIDEO"];function Y(e){return b(e,B)}function X(e){return P(e,B)}function b(e,t){return t.indexOf(e.nodeName)>=0}function P(e,t){return e.getElementsByTagName&&t.some(function(n){return e.getElementsByTagName(n).length})}var l={};l.paragraph={filter:"p",replacement:function(e){return`

`+e+`

`}};l.lineBreak={filter:"br",replacement:function(e,t,n){return n.br+`
`}};l.heading={filter:["h1","h2","h3","h4","h5","h6"],replacement:function(e,t,n){var r=Number(t.nodeName.charAt(1));if(n.headingStyle==="setext"&&r<3){var i=k(r===1?"=":"-",e.length);return`

`+e+`
`+i+`

`}else return`

`+k("#",r)+" "+e+`

`}};l.blockquote={filter:"blockquote",replacement:function(e){return e=e.replace(/^\n+|\n+$/g,""),e=e.replace(/^/gm,"> "),`

`+e+`

`}};l.list={filter:["ul","ol"],replacement:function(e,t){var n=t.parentNode;return n.nodeName==="LI"&&n.lastElementChild===t?`
`+e:`

`+e+`

`}};l.listItem={filter:"li",replacement:function(e,t,n){var r=n.bulletListMarker+"   ",i=t.parentNode;if(i.nodeName==="OL"){var o=i.getAttribute("start"),a=Array.prototype.indexOf.call(i.children,t);r=(o?Number(o)+a:a+1)+".  "}return e=e.replace(/^\n+/,"").replace(/\n+$/,`
`).replace(/\n/gm,`
`+" ".repeat(r.length)),r+e+(t.nextSibling&&!/\n$/.test(e)?`
`:"")}};l.indentedCodeBlock={filter:function(e,t){return t.codeBlockStyle==="indented"&&e.nodeName==="PRE"&&e.firstChild&&e.firstChild.nodeName==="CODE"},replacement:function(e,t,n){return`

    `+t.firstChild.textContent.replace(/\n/g,`
    `)+`

`}};l.fencedCodeBlock={filter:function(e,t){return t.codeBlockStyle==="fenced"&&e.nodeName==="PRE"&&e.firstChild&&e.firstChild.nodeName==="CODE"},replacement:function(e,t,n){for(var r=t.firstChild.getAttribute("class")||"",i=(r.match(/language-(\S+)/)||[null,""])[1],o=t.firstChild.textContent,a=n.fence.charAt(0),u=3,s=new RegExp("^"+a+"{3,}","gm"),d;d=s.exec(o);)d[0].length>=u&&(u=d[0].length+1);var h=k(a,u);return`

`+h+i+`
`+o.replace(/\n$/,"")+`
`+h+`

`}};l.horizontalRule={filter:"hr",replacement:function(e,t,n){return`

`+n.hr+`

`}};l.inlineLink={filter:function(e,t){return t.linkStyle==="inlined"&&e.nodeName==="A"&&e.getAttribute("href")},replacement:function(e,t){var n=t.getAttribute("href");n&&(n=n.replace(/([()])/g,"\\$1"));var r=p(t.getAttribute("title"));return r&&(r=' "'+r.replace(/"/g,'\\"')+'"'),"["+e+"]("+n+r+")"}};l.referenceLink={filter:function(e,t){return t.linkStyle==="referenced"&&e.nodeName==="A"&&e.getAttribute("href")},replacement:function(e,t,n){var r=t.getAttribute("href"),i=p(t.getAttribute("title"));i&&(i=' "'+i+'"');var o,a;switch(n.linkReferenceStyle){case"collapsed":o="["+e+"][]",a="["+e+"]: "+r+i;break;case"shortcut":o="["+e+"]",a="["+e+"]: "+r+i;break;default:var u=this.references.length+1;o="["+e+"]["+u+"]",a="["+u+"]: "+r+i}return this.references.push(a),o},references:[],append:function(e){var t="";return this.references.length&&(t=`

`+this.references.join(`
`)+`

`,this.references=[]),t}};l.emphasis={filter:["em","i"],replacement:function(e,t,n){return e.trim()?n.emDelimiter+e+n.emDelimiter:""}};l.strong={filter:["strong","b"],replacement:function(e,t,n){return e.trim()?n.strongDelimiter+e+n.strongDelimiter:""}};l.code={filter:function(e){var t=e.previousSibling||e.nextSibling,n=e.parentNode.nodeName==="PRE"&&!t;return e.nodeName==="CODE"&&!n},replacement:function(e){if(!e)return"";e=e.replace(/\r?\n|\r/g," ");for(var t=/^`|^ .*?[^ ].* $|`$/.test(e)?" ":"",n="`",r=e.match(/`+/gm)||[];r.indexOf(n)!==-1;)n=n+"`";return n+t+e+t+n}};l.image={filter:"img",replacement:function(e,t){var n=p(t.getAttribute("alt")),r=t.getAttribute("src")||"",i=p(t.getAttribute("title")),o=i?' "'+i+'"':"";return r?"!["+n+"]("+r+o+")":""}};function p(e){return e?e.replace(/(\n+\s*)+/g,`
`):""}function x(e){this.options=e,this._keep=[],this._remove=[],this.blankRule={replacement:e.blankReplacement},this.keepReplacement=e.keepReplacement,this.defaultRule={replacement:e.defaultReplacement},this.array=[];for(var t in e.rules)this.array.push(e.rules[t])}x.prototype={add:function(e,t){this.array.unshift(t)},keep:function(e){this._keep.unshift({filter:e,replacement:this.keepReplacement})},remove:function(e){this._remove.unshift({filter:e,replacement:function(){return""}})},forNode:function(e){if(e.isBlank)return this.blankRule;var t;return(t=w(this.array,e,this.options))||(t=w(this._keep,e,this.options))||(t=w(this._remove,e,this.options))?t:this.defaultRule},forEach:function(e){for(var t=0;t<this.array.length;t++)e(this.array[t],t)}};function w(e,t,n){for(var r=0;r<e.length;r++){var i=e[r];if(z(i,t,n))return i}}function z(e,t,n){var r=e.filter;if(typeof r=="string"){if(r===t.nodeName.toLowerCase())return!0}else if(Array.isArray(r)){if(r.indexOf(t.nodeName.toLowerCase())>-1)return!0}else if(typeof r=="function"){if(r.call(e,t,n))return!0}else throw new TypeError("`filter` needs to be a string, array, or function")}function K(e){var t=e.element,n=e.isBlock,r=e.isVoid,i=e.isPre||function(H){return H.nodeName==="PRE"};if(!(!t.firstChild||i(t))){for(var o=null,a=!1,u=null,s=C(u,t,i);s!==t;){if(s.nodeType===3||s.nodeType===4){var d=s.data.replace(/[ \r\n\t]+/g," ");if((!o||/ $/.test(o.data))&&!a&&d[0]===" "&&(d=d.substr(1)),!d){s=E(s);continue}s.data=d,o=s}else if(s.nodeType===1)n(s)||s.nodeName==="BR"?(o&&(o.data=o.data.replace(/ $/,"")),o=null,a=!1):r(s)||i(s)?(o=null,a=!0):o&&(a=!1);else{s=E(s);continue}var h=C(u,s,i);u=s,s=h}o&&(o.data=o.data.replace(/ $/,""),o.data||E(o))}}function E(e){var t=e.nextSibling||e.parentNode;return e.parentNode.removeChild(e),t}function C(e,t,n){return e&&e.parentNode===t||n(t)?t.nextSibling||t.parentNode:t.firstChild||t.nextSibling||t.parentNode}var S=typeof window<"u"?window:{};function Q(){var e=S.DOMParser,t=!1;try{new e().parseFromString("","text/html")&&(t=!0)}catch{}return t}function J(){var e=function(){};return Z()?e.prototype.parseFromString=function(t){var n=new window.ActiveXObject("htmlfile");return n.designMode="on",n.open(),n.write(t),n.close(),n}:e.prototype.parseFromString=function(t){var n=document.implementation.createHTMLDocument("");return n.open(),n.write(t),n.close(),n},e}function Z(){var e=!1;try{document.implementation.createHTMLDocument("").open()}catch{S.ActiveXObject&&(e=!0)}return e}var ee=Q()?S.DOMParser:J();function te(e,t){var n;if(typeof e=="string"){var r=ne().parseFromString('<x-turndown id="turndown-root">'+e+"</x-turndown>","text/html");n=r.getElementById("turndown-root")}else n=e.cloneNode(!0);return K({element:n,isBlock:N,isVoid:I,isPre:t.preformattedCode?re:null}),n}var T;function ne(){return T=T||new ee,T}function re(e){return e.nodeName==="PRE"||e.nodeName==="CODE"}function ie(e,t){return e.isBlock=N(e),e.isCode=e.nodeName==="CODE"||e.parentNode.isCode,e.isBlank=oe(e),e.flankingWhitespace=ae(e,t),e}function oe(e){return!I(e)&&!Y(e)&&/^\s*$/i.test(e.textContent)&&!G(e)&&!X(e)}function ae(e,t){if(e.isBlock||t.preformattedCode&&e.isCode)return{leading:"",trailing:""};var n=se(e.textContent);return n.leadingAscii&&O("left",e,t)&&(n.leading=n.leadingNonAscii),n.trailingAscii&&O("right",e,t)&&(n.trailing=n.trailingNonAscii),{leading:n.leading,trailing:n.trailing}}function se(e){var t=e.match(/^(([ \t\r\n]*)(\s*))(?:(?=\S)[\s\S]*\S)?((\s*?)([ \t\r\n]*))$/);return{leading:t[1],leadingAscii:t[2],leadingNonAscii:t[3],trailing:t[4],trailingNonAscii:t[5],trailingAscii:t[6]}}function O(e,t,n){var r,i,o;return e==="left"?(r=t.previousSibling,i=/ $/):(r=t.nextSibling,i=/^ /),r&&(r.nodeType===3?o=i.test(r.nodeValue):n.preformattedCode&&r.nodeName==="CODE"?o=!1:r.nodeType===1&&!N(r)&&(o=i.test(r.textContent))),o}var le=Array.prototype.reduce,ce=[[/\\/g,"\\\\"],[/\*/g,"\\*"],[/^-/g,"\\-"],[/^\+ /g,"\\+ "],[/^(=+)/g,"\\$1"],[/^(#{1,6}) /g,"\\$1 "],[/`/g,"\\`"],[/^~~~/g,"\\~~~"],[/\[/g,"\\["],[/\]/g,"\\]"],[/^>/g,"\\>"],[/_/g,"\\_"],[/^(\d+)\. /g,"$1\\. "]];function m(e){if(!(this instanceof m))return new m(e);var t={rules:l,headingStyle:"setext",hr:"* * *",bulletListMarker:"*",codeBlockStyle:"indented",fence:"```",emDelimiter:"_",strongDelimiter:"**",linkStyle:"inlined",linkReferenceStyle:"full",br:"  ",preformattedCode:!1,blankReplacement:function(n,r){return r.isBlock?`

`:""},keepReplacement:function(n,r){return r.isBlock?`

`+r.outerHTML+`

`:r.outerHTML},defaultReplacement:function(n,r){return r.isBlock?`

`+n+`

`:n}};this.options=U({},t,e),this.rules=new x(this.options)}m.prototype={turndown:function(e){if(!fe(e))throw new TypeError(e+" is not a string, or an element/document/fragment node.");if(e==="")return"";var t=M.call(this,new te(e,this.options));return ue.call(this,t)},use:function(e){if(Array.isArray(e))for(var t=0;t<e.length;t++)this.use(e[t]);else if(typeof e=="function")e(this);else throw new TypeError("plugin must be a Function or an Array of Functions");return this},addRule:function(e,t){return this.rules.add(e,t),this},keep:function(e){return this.rules.keep(e),this},remove:function(e){return this.rules.remove(e),this},escape:function(e){return ce.reduce(function(t,n){return t.replace(n[0],n[1])},e)}};function M(e){var t=this;return le.call(e.childNodes,function(n,r){r=new ie(r,t.options);var i="";return r.nodeType===3?i=r.isCode?r.nodeValue:t.escape(r.nodeValue):r.nodeType===1&&(i=de.call(t,r)),_(n,i)},"")}function ue(e){var t=this;return this.rules.forEach(function(n){typeof n.append=="function"&&(e=_(e,n.append(t.options)))}),e.replace(/^[\t\r\n]+/,"").replace(/[\t\r\n\s]+$/,"")}function de(e){var t=this.rules.forNode(e),n=M.call(this,e),r=e.flankingWhitespace;return(r.leading||r.trailing)&&(n=n.trim()),r.leading+t.replacement(n,e,this.options)+r.trailing}function _(e,t){var n=j(e),r=V(t),i=Math.max(e.length-n.length,t.length-r.length),o=`

`.substring(0,i);return n+o+r}function fe(e){return e!=null&&(typeof e=="string"||e.nodeType&&(e.nodeType===1||e.nodeType===9||e.nodeType===11))}const he="#thread article";class pe{static parse(){const t=[],n=new m,r=document.querySelectorAll(he);if(!r||r.length===0)return"";for(const i of r){const o=i.getAttribute("data-turn-id");if(!o)continue;const a=i.innerHTML,u=n.turndown(a);u&&(t[o]=u)}return t}}const c=class c{constructor(t,n){this.downloadFormats=t,this.onFormatSelectedCallback=n,this.dropdown=null,this.dropdownAnchor=null,this.detachDropdownListeners=null}init(){this.injectStyles(),this.attachDownloadButton(),this.observeShareButton()}injectStyles(){if(document.getElementById(c.STYLE_ID))return;const t=document.createElement("style");t.id=c.STYLE_ID,t.textContent=`
      #${c.DOWNLOAD_BUTTON_ID} svg {
        transform: rotate(180deg);
      }
    `,document.head.appendChild(t)}observeShareButton(){new MutationObserver(()=>this.attachDownloadButton()).observe(document.body,{childList:!0,subtree:!0})}attachDownloadButton(){const t=document.querySelector(c.SHARE_BUTTON_SELECTOR);if(!t)return;const n=t.parentElement;if(!n||n.querySelector(`#${c.DOWNLOAD_BUTTON_ID}`))return;const r=this.cloneShareButton(t);n.insertBefore(r,t.nextSibling)}cloneShareButton(t){const n=t.cloneNode(!0);n.id=c.DOWNLOAD_BUTTON_ID,n.setAttribute("aria-label","Download conversation"),n.dataset.testid="download-chat-button";const r=n.querySelector(".flex");r&&this.replaceLabel(r,"Download");const i=n.querySelector("svg");return i&&i.setAttribute("aria-label","Download icon"),n.addEventListener("click",o=>{o.preventDefault(),o.stopPropagation(),this.toggleDropdown(n)}),n}replaceLabel(t,n){let r=!1;for(const i of Array.from(t.childNodes))i.nodeType===Node.TEXT_NODE&&(i.textContent=n,r=!0);r||t.appendChild(document.createTextNode(n))}toggleDropdown(t){if(this.dropdown&&this.dropdownAnchor===t){this.closeDropdown();return}this.openDropdown(t)}openDropdown(t){const n=this.ensureDropdown();if(n.hidden=!1,n.style.visibility="hidden",this.positionDropdown(t,n),n.style.visibility="",n.setAttribute("data-state","open"),this.dropdown=n,this.dropdownAnchor=t,!this.detachDropdownListeners){const r=o=>{var a;this.dropdown&&((a=this.dropdownAnchor)!=null&&a.contains(o.target)||this.dropdown.contains(o.target)||this.closeDropdown())},i=o=>{o.key==="Escape"&&this.closeDropdown()};document.addEventListener("click",r,!0),document.addEventListener("keydown",i),this.detachDropdownListeners=()=>{document.removeEventListener("click",r,!0),document.removeEventListener("keydown",i),this.detachDropdownListeners=null}}}closeDropdown(){this.dropdown&&(this.dropdown.hidden=!0,this.dropdown.setAttribute("data-state","closed"),this.dropdown=null,this.dropdownAnchor=null,this.detachDropdownListeners&&this.detachDropdownListeners())}ensureDropdown(){let t=document.getElementById(c.DROPDOWN_ID);if(t)return t;t=document.createElement("div"),t.id=c.DROPDOWN_ID,t.setAttribute("role","menu"),t.setAttribute("data-state","closed"),t.className="z-50 absolute rounded-2xl bg-token-main-surface-primary dark:bg-[#353535] shadow-long py-1.5 border border-token-border-light min-w-[180px] text-token-text-primary",t.hidden=!0;const n=document.createElement("div");return n.setAttribute("role","group"),n.className="flex flex-col gap-1",n.appendChild(this.createDropdownItem("JSON",this.downloadFormats.json)),n.appendChild(this.createDropdownItem("Markdown",this.downloadFormats.markdown)),t.appendChild(n),document.body.appendChild(t),t}createDropdownItem(t,n){const r=document.createElement("button");return r.type="button",r.setAttribute("role","menuitem"),r.dataset.option=n,r.className="__menu-item flex w-full items-center gap-1.5 px-4 py-2 text-sm text-left hover:bg-token-main-surface-secondary rounded-xl focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-token-border-light",r.textContent=t,r.addEventListener("click",i=>{i.preventDefault(),i.stopPropagation(),this.closeDropdown(),this.onFormatSelectedCallback(n)}),r}positionDropdown(t,n){const r=t.getBoundingClientRect(),i=window.scrollY||document.documentElement.scrollTop||0,o=window.scrollX||document.documentElement.scrollLeft||0;n.style.top=`${r.bottom+i+8}px`,n.style.left=`${r.right+o-n.offsetWidth}px`}};f(c,"SHARE_BUTTON_SELECTOR",'button[data-testid="share-chat-button"]'),f(c,"DOWNLOAD_BUTTON_ID","chatgpt-save-download-button"),f(c,"STYLE_ID","chatgpt-save-style"),f(c,"DROPDOWN_ID","chatgpt-save-download-dropdown");let y=c;const R=Object.freeze({json:"json",markdown:"markdown"}),v=class v{requestDownload(t){return new Promise((n,r)=>{chrome.runtime.sendMessage({type:v.MESSAGE_TYPE,payload:t},i=>{const o=chrome.runtime.lastError;if(o){r(new Error(o.message));return}if(!(i!=null&&i.ok)){r(new Error((i==null?void 0:i.error)||"Download failed."));return}n(i)})})}};f(v,"MESSAGE_TYPE","CHATGPT_SAVE_DOWNLOAD_REQUEST");let A=v;class me{constructor(){this.apiHandler=new W,this.bridge=new A,this.ui=new y(R,(function(t){return this.handleDownload(t)}).bind(this))}init(){this.ui.init()}async handleDownload(t){try{const n=await this.apiHandler.fetchConversation();if(!n)throw new Error("Conversation payload was empty.");const r={format:t,openAIResponse:n};if(t===R.markdown){const i=pe.parse();r.markdownMessages=i}await this.bridge.requestDownload(r)}catch(n){console.warn("ChatGPT Save: failed to prepare download.",n)}}}new me().init();
